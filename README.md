# OPAL Single Topic Multi-Tenant Solution

## üöÄ Rewolucyjne podej≈õcie do wielodostƒôpno≈õci w OPAL

To repozytorium zawiera **prze≈Çomowe rozwiƒÖzanie** problemu wielodostƒôpno≈õci (multi-tenancy) w OPAL, kt√≥re eliminuje potrzebƒô restartowania systemu przy dodawaniu nowych tenant√≥w.

### üéØ Kluczowe odkrycie

#### üö´ Dlaczego tradycyjne podej≈õcie wymaga restartu?

**Tradycyjne podej≈õcie** - jeden topic na tenant:
```bash
# ‚ùå Ka≈ºdy tenant = osobny topic = restart wymagany
OPAL_DATA_TOPICS=tenant_1_data,tenant_2_data,tenant_3_data
```

**Problem:** OPAL Client **subskrybuje topics podczas startu** i nie posiada mechanizmu dynamicznego dodawania nowych subskrypcji w runtime. To oznacza:

1. **OPAL Client startuje** z listƒÖ topics z `OPAL_DATA_TOPICS`
2. **Tworzy WebSocket connections** tylko dla tych topics
3. **Nowy tenant = nowy topic** nie jest automatycznie subskrybowany
4. **Jedyne rozwiƒÖzanie:** restart OPAL Client z rozszerzonƒÖ listƒÖ topics

#### ‚úÖ Dlaczego nasze podej≈õcie nie wymaga restartu?

**Nasze odkrycie** - jeden topic dla wszystkich:
```bash
# ‚úÖ Jeden topic dla wszystkich tenant√≥w = ZERO restart√≥w!
OPAL_DATA_TOPICS=tenant_data
```

**RozwiƒÖzanie:** Wykorzystujemy **jeden topic + wiele dynamicznych data sources** z hierarchiƒÖ ≈õcie≈ºek w OPA:

1. **OPAL Client subskrybuje** jeden topic `tenant_data` podczas startu
2. **Wszystkie eventy** dla wszystkich tenant√≥w u≈ºywajƒÖ tego samego topic  
3. **Ka≈ºdy tenant = osobny data source** dynamicznie dodawany przez API:
   ```bash
   # Tenant1 data source
   POST /data/config: {
     "url": "http://api-provider:80/acl/tenant1",  # Unikalne URL
     "topics": ["tenant_data"],                     # Ten sam topic
     "dst_path": "/acl/tenant1"                     # Unikalna ≈õcie≈ºka OPA
   }
   
   # Tenant2 data source  
   POST /data/config: {
     "url": "http://api-provider:80/acl/tenant2",  # Inne URL
     "topics": ["tenant_data"],                     # Ten sam topic
     "dst_path": "/acl/tenant2"                     # Inna ≈õcie≈ºka OPA
   }
   ```
4. **Nowy tenant:** nowy data source na istniejƒÖcy topic (bez restartu!)

#### üîç Mechanizm techniczny

```
Tradycyjne (restart wymagany):
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    topics: tenant_1_data     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   OPAL Server   ‚îÇ‚óÑ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÇ   OPAL Client   ‚îÇ
‚îÇ                 ‚îÇ    topics: tenant_2_data     ‚îÇ                 ‚îÇ
‚îÇ  Multi Topics   ‚îÇ‚óÑ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÇ  Multi Subscribe ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    topics: tenant_3_data     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                       ‚ö†Ô∏è  Nowy topic = RESTART

Nasze rozwiƒÖzanie (bez restartu):
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    topic: tenant_data        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   OPAL Server   ‚îÇ‚óÑ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÇ   OPAL Client   ‚îÇ
‚îÇ                 ‚îÇ    (dla wszystkich)          ‚îÇ                 ‚îÇ
‚îÇ  Single Topic   ‚îÇ                              ‚îÇ Single Subscribe ‚îÇ
‚îÇ  Multi Sources: ‚îÇ                              ‚îÇ Multi Data Fetch ‚îÇ
‚îÇ  - /acl/tenant1 ‚îÇ                              ‚îÇ - URL1‚Üí/acl/ten1 ‚îÇ
‚îÇ  - /acl/tenant2 ‚îÇ                              ‚îÇ - URL2‚Üí/acl/ten2 ‚îÇ
‚îÇ  - /acl/tenant3 ‚îÇ                              ‚îÇ - URL3‚Üí/acl/ten3 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                              ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                       ‚úÖ Jeden topic, wiele sources, r√≥≈ºne ≈õcie≈ºki
```

#### üìä Izolacja danych

**Kluczowa obserwacja:** Izolacja tenant√≥w **NIE musi** odbywaƒá siƒô na poziomie OPAL topics. OPA oferuje naturalnƒÖ hierarchiƒô ≈õcie≈ºek:

```json
{
  "acl": {
    "tenant1": { "users": [...], "resources": [...] },
    "tenant2": { "users": [...], "resources": [...] },
    "tenant3": { "users": [...], "resources": [...] }
  }
}
```

Ka≈ºdy tenant ma w≈ÇasnƒÖ przestrze≈Ñ w OPA, ale wszyscy u≈ºywajƒÖ tego samego mechanizmu dostarczania danych.

### üèóÔ∏è Architektura

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   OPAL Server   ‚îÇ‚óÑ‚îÄ‚îÄ‚ñ∫‚îÇ   OPAL Client   ‚îÇ‚óÑ‚îÄ‚îÄ‚ñ∫‚îÇ      OPA        ‚îÇ
‚îÇ                 ‚îÇ    ‚îÇ                 ‚îÇ    ‚îÇ                 ‚îÇ
‚îÇ Single Topic:   ‚îÇ    ‚îÇ Data Fetcher    ‚îÇ    ‚îÇ /acl/tenant1    ‚îÇ
‚îÇ "tenant_data"   ‚îÇ    ‚îÇ HTTP Provider   ‚îÇ    ‚îÇ /acl/tenant2    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îÇ /acl/tenant3    ‚îÇ
         ‚ñ≤                       ‚ñ≤             ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ                       ‚îÇ
         ‚îÇ              ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∫‚îÇ Simple API      ‚îÇ
                         ‚îÇ Provider        ‚îÇ
                         ‚îÇ (nginx)         ‚îÇ
                         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### üéÅ Korzy≈õci

- **üîÑ Zero Downtime**: Dodawanie tenant√≥w bez restartu
- **üìà Liniowa skalowalno≈õƒá**: Jeden topic obs≈Çuguje N tenant√≥w  
- **üõ°Ô∏è Pe≈Çna izolacja**: Dane tenant√≥w pozostajƒÖ oddzielone
- **‚ö° Wydajno≈õƒá**: Brak overhead dla wielu topics
- **üß© Simplicitas**: Uproszczona konfiguracja

### üìÅ Zawarto≈õƒá repozytorium

```
‚îú‚îÄ‚îÄ docker-compose.yml              # Kompletna konfiguracja OPAL
‚îú‚îÄ‚îÄ policies/                       # Polityki rego z nowƒÖ sk≈ÇadniƒÖ 'if'
‚îÇ   ‚îú‚îÄ‚îÄ access.rego                 # Kontrola dostƒôpu
‚îÇ   ‚îú‚îÄ‚îÄ roles.rego                  # ZarzƒÖdzanie rolami  
‚îÇ   ‚îî‚îÄ‚îÄ allow.rego                  # Regu≈Çy autoryzacji
‚îú‚îÄ‚îÄ simple-api-provider/            # Mock API dla danych tenant√≥w
‚îÇ   ‚îî‚îÄ‚îÄ nginx.conf                  # Konfiguracja nginx
‚îî‚îÄ‚îÄ test-single-topic-multi-tenant.sh  # Skrypt testowy
```

## üöÄ Szybki start

### 1. Uruchomienie systemu

```bash
# Klonowanie repozytorium
git clone https://github.com/plduser/opa-zero-poll-single-topic-multi-tenant.git
cd opa-zero-poll-single-topic-multi-tenant

# Uruchomienie wszystkich us≈Çug
docker-compose up -d

# Sprawdzenie statusu (wszystkie kontenery powinny byƒá 'running')
docker-compose ps
```

### 2. Weryfikacja dzia≈Çania

```bash
# Sprawdzenie health endpoints
curl http://localhost:8181/health        # OPA health
curl http://localhost:7002/healthcheck   # OPAL Server health
curl http://localhost:8090/acl/tenant1   # API Provider
```

### 3. Test Single Topic Multi-Tenant

#### Krok 1: Dodanie pierwszego tenanta
```bash
curl -X POST http://localhost:7002/data/config \
  -H "Content-Type: application/json" \
  -d '{
    "entries": [{
      "url": "http://host.docker.internal:8090/acl/tenant1",  # Unikalne URL
      "topics": ["tenant_data"],                               # Ten sam topic
      "dst_path": "/acl/tenant1"                               # Unikalna ≈õcie≈ºka OPA
    }],
    "reason": "Load tenant1 data via single topic"
  }'
```

#### Krok 2: Dodanie drugiego tenanta **BEZ RESTARTU**
```bash
curl -X POST http://localhost:7002/data/config \
  -H "Content-Type: application/json" \
  -d '{
    "entries": [{
      "url": "http://host.docker.internal:8090/acl/tenant2",  # Inne URL
      "topics": ["tenant_data"],                               # Ten sam topic  
      "dst_path": "/acl/tenant2"                               # Inna ≈õcie≈ºka OPA
    }],
    "reason": "Load tenant2 data - NO RESTART NEEDED!"
  }'
```

> **üí° Kluczowa obserwacja:** Ka≈ºdy tenant ma:
> - **R√≥≈ºne URL ≈∫r√≥d≈Ça danych** (`/acl/tenant1` vs `/acl/tenant2`)
> - **Ten sam topic** (`tenant_data`)  
> - **R√≥≈ºne ≈õcie≈ºki docelowe** w OPA (`/acl/tenant1` vs `/acl/tenant2`)

#### Krok 3: Weryfikacja izolacji danych
```bash
# Sprawdzenie danych tenant1
curl http://localhost:8181/v1/data/acl/tenant1 | jq .

# Sprawdzenie danych tenant2  
curl http://localhost:8181/v1/data/acl/tenant2 | jq .

# Sprawdzenie wszystkich danych
curl http://localhost:8181/v1/data/acl | jq .
```

### 4. Test polityk z nowƒÖ sk≈ÇadniƒÖ

```bash
# Test autoryzacji RBAC
curl -X POST http://localhost:8181/v1/data/policies/rbac/allow \
  -H "Content-Type: application/json" \
  -d '{
    "input": {
      "user": "alice",
      "action": "read", 
      "resource": "document1",
      "tenant_id": "tenant1"
    }
  }' | jq .
```

## üß™ Automatyczny test

U≈ºyj do≈ÇƒÖczonego skryptu do pe≈Çnego testu:

```bash
chmod +x test-single-topic-multi-tenant.sh
./test-single-topic-multi-tenant.sh
```

## üîß Konfiguracja

### Kluczowe parametry w docker-compose.yml:

```yaml
# OPAL Client - rewolucyjna konfiguracja single topic
environment:
  - OPAL_DATA_TOPICS=tenant_data  # ‚≠ê Jeden topic dla wszystkich!
  - OPAL_DATA_UPDATER_ENABLED=true
  - OPAL_FETCH_TIMEOUT=30
```

### Struktura danych w OPA:

```json
{
  "acl": {
    "tenant1": {
      "users": [{"name": "alice", "role": "admin"}],
      "resources": [{"name": "document1", "owner": "alice"}]
    },
    "tenant2": {
      "users": [{"name": "charlie", "role": "manager"}], 
      "resources": [{"name": "file1", "owner": "charlie"}]
    }
  }
}
```

## üìä Por√≥wnanie wydajno≈õci

| Metryka | Tradycyjne Multi-Topic | Single Topic (nasze) |
|---------|------------------------|----------------------|
| **Restart przy dodaniu tenanta** | ‚úÖ Wymagany | ‚ùå Nie wymagany |
| **Liczba topics** | N (jeden na tenant) | 1 (dla wszystkich) |
| **Memory overhead** | O(N) | O(1) |
| **Czas wdro≈ºenia** | Minuty (restart) | Sekundy (live) |
| **Skalowalno≈õƒá** | Ograniczona | Nieograniczona |

## üõ†Ô∏è RozwiƒÖzywanie problem√≥w

### Problem: Kontenery nie startujƒÖ
```bash
# Sprawd≈∫ logi
docker-compose logs opal-server
docker-compose logs opal-client

# Restart systemu
docker-compose down && docker-compose up -d
```

### Problem: Dane nie ≈ÇadujƒÖ siƒô do OPA
```bash
# Sprawd≈∫ czy API Provider odpowiada
curl -v http://localhost:8090/acl/tenant1

# Sprawd≈∫ logi OPAL Client
docker logs opa-zero-poll-single-topic-multi-tenant-opal-client-1
```

### Problem: B≈ÇƒÖd Content-Type
Upewnij siƒô, ≈ºe nginx zwraca `Content-Type: application/json`:
```nginx
location /acl/tenant1 {
    default_type application/json;  # ‚úÖ Poprawne
    # add_header Content-Type application/json;  # ‚ùå Niepoprawne
}
```

## üìã Wymagania systemowe

- **Docker**: >= 20.10
- **Docker Compose**: >= 2.0
- **System**: Linux/macOS (ARM64/AMD64)
- **RAM**: Minimum 2GB dostƒôpnej pamiƒôci
- **Porty**: 7001, 7002, 8090, 8181, 8282

## üîó Przydatne linki

- [Open Policy Agent (OPA)](https://www.openpolicyagent.org/)
- [OPAL Documentation](https://docs.opal.ac/)
- [Rego Language Guide](https://www.openpolicyagent.org/docs/latest/policy-language/)

## üìÑ Licencja

MIT License - zobacz [LICENSE](LICENSE) dla szczeg√≥≈Ç√≥w.

---

**üåü Je≈õli to rozwiƒÖzanie rozwiƒÖzuje Tw√≥j problem z multi-tenancy w OPAL, rozwa≈º contribution do g≈Ç√≥wnego projektu OPAL!** 